<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 å·¥ä½œ Review - DeepSeek V3 Review</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">ğŸ” V3 å·¥ä½œ Review</h1>
                        <p class="text-sm text-gray-500 mt-1">DeepSeek V3 å…¨é¢è¯„ä»·ç³»ç»Ÿ - æŒç»­æ”¹è¿›</p>
                    </div>
                    <div class="flex gap-2">
                        <button @click="runComprehensiveReview" :disabled="reviewing"
                                class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400">
                            {{ reviewing ? 'Review ä¸­...' : 'ğŸš€ å…¨é¢ Review' }}
                        </button>
                        <button @click="saveReport" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                            ğŸ’¾ ä¿å­˜æŠ¥å‘Š
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">å¹³å‡è¯„åˆ†</div>
                    <div class="text-2xl font-bold" :class="getScoreColor(avgScore)">{{ avgScore }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">ä»£ç è´¨é‡</div>
                    <div class="text-2xl font-bold" :class="getScoreColor(codeScore)">{{ codeScore || '-' }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">æ–‡æ¡£è´¨é‡</div>
                    <div class="text-2xl font-bold" :class="getScoreColor(docScore)">{{ docScore || '-' }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">é¡¹ç›®è¿›åº¦</div>
                    <div class="text-2xl font-bold" :class="getScoreColor(progressScore)">{{ progressScore || '-' }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">æµ‹è¯•è¦†ç›–</div>
                    <div class="text-2xl font-bold" :class="getScoreColor(testScore)">{{ testScore || '-' }}</div>
                </div>
            </div>

            <!-- Review ç±»å‹é€‰æ‹© -->
            <div class="bg-white rounded-lg shadow p-4 mb-6">
                <h2 class="text-lg font-semibold mb-4">ğŸ“‹ Review ç±»å‹</h2>
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <button @click="runCodeReview" :disabled="reviewing"
                            class="p-4 rounded-lg border-2 hover:border-blue-500 hover:bg-blue-50">
                        <div class="text-2xl mb-2">ğŸ’»</div>
                        <div class="font-semibold">ä»£ç  Review</div>
                        <div class="text-xs text-gray-500">ä»£ç è´¨é‡/æ¶æ„/è§„èŒƒ</div>
                    </button>
                    <button @click="runDocReview" :disabled="reviewing"
                            class="p-4 rounded-lg border-2 hover:border-blue-500 hover:bg-blue-50">
                        <div class="text-2xl mb-2">ğŸ“„</div>
                        <div class="font-semibold">æ–‡æ¡£ Review</div>
                        <div class="text-xs text-gray-500">å®Œæ•´æ€§/æ¸…æ™°åº¦</div>
                    </button>
                    <button @click="runProgressReview" :disabled="reviewing"
                            class="p-4 rounded-lg border-2 hover:border-blue-500 hover:bg-blue-50">
                        <div class="text-2xl mb-2">ğŸ“Š</div>
                        <div class="font-semibold">è¿›åº¦ Review</div>
                        <div class="text-xs text-gray-500">å¼€å‘æ•ˆç‡/é‡Œç¨‹ç¢‘</div>
                    </button>
                    <button @click="runTestReview" :disabled="reviewing"
                            class="p-4 rounded-lg border-2 hover:border-blue-500 hover:bg-blue-50">
                        <div class="text-2xl mb-2">ğŸ§ª</div>
                        <div class="font-semibold">æµ‹è¯• Review</div>
                        <div class="text-xs text-gray-500">è¦†ç›–ç‡/è´¨é‡</div>
                    </button>
                    <button @click="runComprehensiveReview" :disabled="reviewing"
                            class="p-4 rounded-lg border-2 hover:border-blue-500 hover:bg-blue-50 bg-blue-50">
                        <div class="text-2xl mb-2">ğŸš€</div>
                        <div class="font-semibold">å…¨é¢ Review</div>
                        <div class="text-xs text-gray-500">å…¨éƒ¨ç»´åº¦</div>
                    </button>
                </div>
            </div>

            <!-- Review ç»“æœ -->
            <div v-if="currentResult" class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 mb-2">
                            {{ currentResult.review_type === 'comprehensive' ? 'ğŸš€ å…¨é¢ Review' : 'ğŸ“ ' + getReviewTypeName(currentResult.review_type) }}
                        </h2>
                        <p class="text-sm text-gray-500">Review æ—¶é—´ï¼š{{ formatTime(currentResult.reviewed_at) }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold" :class="getScoreColor(currentResult.total_score)">
                            {{ currentResult.total_score }}
                        </div>
                        <div class="text-lg font-semibold" :class="getScoreColor(currentResult.total_score)">
                            {{ currentResult.grade }}çº§ - {{ currentResult.recommendation }}
                        </div>
                    </div>
                </div>

                <!-- å­è¯„ä»· (å…¨é¢ Review æ—¶æ˜¾ç¤º) -->
                <div v-if="currentResult.sub_reviews" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div v-for="(sub, key) in currentResult.sub_reviews" :key="key" class="p-4 rounded-lg border">
                        <div class="text-sm text-gray-500 mb-1">{{ getSubReviewName(key) }}</div>
                        <div class="text-2xl font-bold" :class="getScoreColor(sub.total_score)">{{ sub.total_score }}</div>
                        <div class="text-xs">{{ sub.grade }}çº§</div>
                    </div>
                </div>

                <!-- é›·è¾¾å›¾ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“Š è¯„åˆ†ç»´åº¦</h3>
                        <canvas ref="radarChart"></canvas>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“ˆ è¯¦ç»†è¯„åˆ†</h3>
                        <div class="space-y-3">
                            <div v-for="(score, dim) in getScores(currentResult)" :key="dim" class="flex items-center gap-2">
                                <span class="text-xs w-20">{{ getDimensionName(dim) }}</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-3">
                                    <div class="bg-blue-500 h-3 rounded-full" :style="{width: score + '%'}"></div>
                                </div>
                                <span class="text-xs w-10 text-right font-semibold">{{ score }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¼˜ç‚¹å’Œå»ºè®® -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">âœ… ä¼˜ç‚¹</h3>
                        <ul class="space-y-2">
                            <li v-for="(s, i) in currentResult.overall_strengths" :key="i" 
                                class="flex items-start gap-2 text-sm text-gray-700">
                                <span class="text-green-500 mt-1">âœ“</span>
                                <span>{{ s }}</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ’¡ æ”¹è¿›å»ºè®®</h3>
                        <ul class="space-y-2">
                            <li v-for="(s, i) in currentResult.overall_improvements" :key="i" 
                                class="flex items-start gap-2 text-sm text-gray-700">
                                <span class="text-orange-500 mt-1">!</span>
                                <span>{{ s }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- æ”¹è¿›è®¡åˆ’ -->
            <div v-if="improvementPlan" class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">ğŸ“‹ æ”¹è¿›è®¡åˆ’</h2>
                    <button @click="generateImprovementPlan" :disabled="generatingPlan"
                            class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 disabled:bg-gray-400">
                        {{ generatingPlan ? 'ç”Ÿæˆä¸­...' : 'âœ¨ ç”Ÿæˆæ”¹è¿›è®¡åˆ’' }}
                    </button>
                </div>

                <div class="space-y-3">
                    <div v-for="(item, i) in improvementPlan.improvement_plan" :key="i"
                         class="p-4 rounded-lg border-l-4"
                         :class="getPriorityColor(item.priority)">
                        <div class="flex justify-between items-start mb-2">
                            <span class="text-xs font-bold px-2 py-0.5 rounded"
                                  :class="getPriorityBadgeColor(item.priority)">
                                {{ item.priority }}
                            </span>
                            <span class="text-xs text-gray-500">é¢„è®¡ {{ item.estimated_hours }} å°æ—¶</span>
                        </div>
                        <div class="font-semibold mb-1">{{ item.action }}</div>
                        <div class="text-sm text-gray-600">éªŒæ”¶ï¼š{{ item.acceptance_criteria }}</div>
                    </div>
                </div>

                <div v-if="improvementPlan.next_review_date" class="mt-4 p-3 bg-gray-50 rounded">
                    <span class="text-sm text-gray-600">ğŸ“… ä¸‹æ¬¡ Review: {{ improvementPlan.next_review_date }}</span>
                </div>
            </div>

            <!-- Review å†å² -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h2 class="text-lg font-semibold">Review å†å²</h2>
                    <p class="text-sm text-gray-500">æœ€è¿‘ {{ history.length }} æ¬¡ Review</p>
                </div>

                <div class="divide-y divide-gray-200">
                    <div v-for="(item, i) in history" :key="i" 
                         class="p-4 hover:bg-gray-50 cursor-pointer"
                         @click="loadReviewDetail(item)">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs px-2 py-0.5 rounded bg-blue-100">
                                        {{ getReviewTypeName(item.review_type) }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ formatTime(item.reviewed_at) }}</span>
                                </div>
                                <div class="text-sm text-gray-600">
                                    {{ item.recommendation || 'Review è®°å½•' }}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold" :class="getScoreColor(item.total_score)">
                                    {{ item.total_score }}
                                </div>
                                <div class="text-sm font-semibold">{{ item.grade }}çº§</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    API_BASE: 'http://43.134.234.4:8002/api/v3/review',
                    reviewing: false,
                    generatingPlan: false,
                    currentResult: null,
                    improvementPlan: null,
                    history: [],
                    chart: null,
                    scores: {
                        code: 0,
                        doc: 0,
                        progress: 0,
                        test: 0
                    }
                }
            },
            computed: {
                avgScore() {
                    const scores = [this.codeScore, this.docScore, this.progressScore, this.testScore].filter(s => s);
                    if (scores.length === 0) return 0;
                    return Math.round(scores.reduce((a, b) => a + b, 0) / scores.length);
                },
                codeScore() { return this.currentResult?.sub_reviews?.code?.total_score || this.scores.code; },
                docScore() { return this.currentResult?.sub_reviews?.doc?.total_score || this.scores.doc; },
                progressScore() { return this.currentResult?.sub_reviews?.progress?.total_score || this.scores.progress; },
                testScore() { return this.currentResult?.sub_reviews?.tests?.total_score || this.scores.test; }
            },
            mounted() {
                this.loadHistory();
            },
            methods: {
                async runComprehensiveReview() {
                    this.reviewing = true;
                    try {
                        const res = await fetch(`${this.API_BASE}/comprehensive`, { method: 'POST' });
                        const data = await res.json();
                        this.currentResult = data.data;
                        this.loadHistory();
                        this.$nextTick(() => this.renderRadarChart());
                    } catch (e) {
                        console.error('Review å¤±è´¥:', e);
                        this.currentResult = this.getMockResult('comprehensive');
                    } finally {
                        this.reviewing = false;
                    }
                },
                async runCodeReview() {
                    this.reviewing = true;
                    try {
                        const res = await fetch(`${this.API_BASE}/code`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({})
                        });
                        const data = await res.json();
                        this.currentResult = data.data;
                        this.$nextTick(() => this.renderRadarChart());
                    } catch (e) {
                        this.currentResult = this.getMockResult('code');
                    } finally {
                        this.reviewing = false;
                    }
                },
                async runDocReview() {
                    this.reviewing = true;
                    try {
                        const res = await fetch(`${this.API_BASE}/docs`, { method: 'POST' });
                        const data = await res.json();
                        this.currentResult = data.data;
                        this.$nextTick(() => this.renderRadarChart());
                    } catch (e) {
                        this.currentResult = this.getMockResult('doc');
                    } finally {
                        this.reviewing = false;
                    }
                },
                async runProgressReview() {
                    this.reviewing = true;
                    try {
                        const res = await fetch(`${this.API_BASE}/progress`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ days: 7 })
                        });
                        const data = await res.json();
                        this.currentResult = data.data;
                        this.$nextTick(() => this.renderRadarChart());
                    } catch (e) {
                        this.currentResult = this.getMockResult('progress');
                    } finally {
                        this.reviewing = false;
                    }
                },
                async runTestReview() {
                    this.reviewing = true;
                    try {
                        const res = await fetch(`${this.API_BASE}/tests`, { method: 'POST' });
                        const data = await res.json();
                        this.currentResult = data.data;
                        this.$nextTick(() => this.renderRadarChart());
                    } catch (e) {
                        this.currentResult = this.getMockResult('test');
                    } finally {
                        this.reviewing = false;
                    }
                },
                async generateImprovementPlan() {
                    if (!this.currentResult) {
                        alert('è¯·å…ˆæ‰§è¡Œ Review');
                        return;
                    }
                    this.generatingPlan = true;
                    try {
                        const res = await fetch(`${this.API_BASE}/improvement-plan`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ review_result: this.currentResult })
                        });
                        const data = await res.json();
                        this.improvementPlan = data.data;
                    } catch (e) {
                        console.error('ç”Ÿæˆè®¡åˆ’å¤±è´¥:', e);
                        this.improvementPlan = this.getMockPlan();
                    } finally {
                        this.generatingPlan = false;
                    }
                },
                async loadHistory() {
                    try {
                        const res = await fetch(`${this.API_BASE}/history?limit=10`);
                        const data = await res.json();
                        this.history = data.data || [];
                    } catch (e) {
                        this.history = [];
                    }
                },
                async saveReport() {
                    try {
                        const res = await fetch(`${this.API_BASE}/save-report`, { method: 'POST' });
                        const data = await res.json();
                        alert(`æŠ¥å‘Šå·²ä¿å­˜ï¼š${data.path}`);
                    } catch (e) {
                        alert('ä¿å­˜å¤±è´¥');
                    }
                },
                loadReviewDetail(item) {
                    this.currentResult = item;
                    this.$nextTick(() => this.renderRadarChart());
                },
                renderRadarChart() {
                    const ctx = this.$refs.radarChart;
                    if (!ctx) return;
                    if (this.chart) this.chart.destroy();

                    const scores = this.getScoreValues(this.currentResult);
                    const labels = Object.keys(scores).map(k => this.getDimensionName(k));
                    const values = Object.values(scores);

                    this.chart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'è¯„åˆ†',
                                data: values,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgb(59, 130, 246)',
                                pointBackgroundColor: 'rgb(59, 130, 246)',
                                pointBorderColor: '#fff'
                            }]
                        },
                        options: {
                            scales: { r: { suggestedMin: 0, suggestedMax: 100 } },
                            plugins: { legend: { display: false } }
                        }
                    });
                },
                getScoreValues(result) {
                    if (!result) return {};
                    if (result.scores) return result.scores;
                    if (result.sub_reviews) {
                        return {
                            code: result.sub_reviews.code?.total_score || 0,
                            doc: result.sub_reviews.documentation?.total_score || 0,
                            progress: result.sub_reviews.progress?.total_score || 0,
                            test: result.sub_reviews.tests?.total_score || 0
                        };
                    }
                    return {};
                },
                getScores(result) {
                    return this.getScoreValues(result);
                },
                getReviewTypeName(type) {
                    const names = {
                        code: 'ä»£ç  Review',
                        documentation: 'æ–‡æ¡£ Review',
                        progress: 'è¿›åº¦ Review',
                        tests: 'æµ‹è¯• Review',
                        comprehensive: 'å…¨é¢ Review'
                    };
                    return names[type] || type;
                },
                getSubReviewName(key) {
                    const names = {
                        code: 'ä»£ç ',
                        documentation: 'æ–‡æ¡£',
                        progress: 'è¿›åº¦',
                        tests: 'æµ‹è¯•'
                    };
                    return names[key] || key;
                },
                getDimensionName(dim) {
                    const names = {
                        code_quality: 'ä»£ç è´¨é‡',
                        architecture: 'æ¶æ„è®¾è®¡',
                        error_handling: 'é”™è¯¯å¤„ç†',
                        performance: 'æ€§èƒ½ä¼˜åŒ–',
                        test_coverage: 'æµ‹è¯•è¦†ç›–',
                        content: 'å†…å®¹å®Œæ•´æ€§',
                        structure: 'ç»“æ„æ¸…æ™°åº¦',
                        expression: 'è¡¨è¾¾å‡†ç¡®æ€§',
                        readability: 'å¯è¯»æ€§',
                        practicality: 'å®ç”¨æ€§',
                        efficiency: 'å¼€å‘æ•ˆç‡',
                        quality: 'ä»£ç è´¨é‡',
                        progress_control: 'è¿›åº¦æ§åˆ¶',
                        collaboration: 'å›¢é˜Ÿåä½œ',
                        tech_debt: 'æŠ€æœ¯å€ºåŠ¡'
                    };
                    return names[dim] || dim;
                },
                getScoreColor(score) {
                    if (!score) return 'text-gray-400';
                    if (score >= 90) return 'text-yellow-600';
                    if (score >= 80) return 'text-blue-600';
                    if (score >= 70) return 'text-green-600';
                    if (score >= 60) return 'text-orange-600';
                    return 'text-red-600';
                },
                getPriorityColor(priority) {
                    const colors = {
                        'P0': 'border-red-500 bg-red-50',
                        'P1': 'border-orange-500 bg-orange-50',
                        'P2': 'border-blue-500 bg-blue-50'
                    };
                    return colors[priority] || 'border-gray-500';
                },
                getPriorityBadgeColor(priority) {
                    const colors = {
                        'P0': 'bg-red-100 text-red-800',
                        'P1': 'bg-orange-100 text-orange-800',
                        'P2': 'bg-blue-100 text-blue-800'
                    };
                    return colors[priority] || 'bg-gray-100 text-gray-800';
                },
                formatTime(timeStr) {
                    if (!timeStr) return '-';
                    const date = new Date(timeStr);
                    return date.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                },
                getMockResult(type) {
                    return {
                        review_type: type,
                        total_score: Math.floor(Math.random() * 30) + 70,
                        grade: ['S', 'A', 'B', 'C'][Math.floor(Math.random() * 4)],
                        recommendation: 'æŒç»­æ”¹è¿›',
                        overall_strengths: ['ä¼˜ç‚¹ 1', 'ä¼˜ç‚¹ 2', 'ä¼˜ç‚¹ 3'],
                        overall_improvements: ['å»ºè®® 1', 'å»ºè®® 2', 'å»ºè®® 3'],
                        reviewed_at: new Date().toISOString(),
                        sub_reviews: type === 'comprehensive' ? {
                            code: { total_score: 85, grade: 'A' },
                            documentation: { total_score: 80, grade: 'A' },
                            progress: { total_score: 75, grade: 'B' },
                            tests: { total_score: 70, grade: 'B' }
                        } : null
                    };
                },
                getMockPlan() {
                    return {
                        improvement_plan: [
                            { priority: 'P0', action: 'ä¿®å¤å…³é”® Bug', estimated_hours: 4, acceptance_criteria: 'æ‰€æœ‰ P0 Bug å…³é—­' },
                            { priority: 'P1', action: 'æå‡æµ‹è¯•è¦†ç›–ç‡åˆ° 80%', estimated_hours: 8, acceptance_criteria: 'è¦†ç›–ç‡æŠ¥å‘Š' },
                            { priority: 'P2', action: 'ä¼˜åŒ–æ–‡æ¡£ç»“æ„', estimated_hours: 3, acceptance_criteria: 'æ–‡æ¡£æ›´æ–°å®Œæˆ' }
                        ],
                        next_review_date: '2026-03-03'
                    };
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
