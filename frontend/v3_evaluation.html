<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V3 å·¥ä½œè¯„ä»· - AI Evaluation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-50">
    <div id="app" class="min-h-screen">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="bg-white shadow-sm sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">ğŸ“Š V3 å·¥ä½œè¯„ä»·</h1>
                        <p class="text-sm text-gray-500 mt-1">AI Evaluation - DeepSeek æ™ºèƒ½è¯„ä¼°</p>
                    </div>
                    <div class="flex items-center gap-4">
                        <select v-model="evalModel" class="border rounded px-3 py-2">
                            <option value="free">DeepSeek å…è´¹æ¨¡å‹</option>
                            <option value="chat">DeepSeek Chat (ä»˜è´¹)</option>
                            <option value="v3">DeepSeek V3</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 py-6">
            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-6">
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">è¯„ä»·æ€»æ•°</div>
                    <div class="text-2xl font-bold text-blue-600">{{ stats.total || 0 }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">å¹³å‡è¯„åˆ†</div>
                    <div class="text-2xl font-bold text-green-600">{{ stats.avg_score || 0 }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">S çº§çˆ†æ¬¾</div>
                    <div class="text-2xl font-bold text-yellow-600">{{ stats.grades?.S || 0 }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">A çº§ä¼˜è´¨</div>
                    <div class="text-2xl font-bold text-blue-600">{{ stats.grades?.A || 0 }}</div>
                </div>
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="text-sm text-gray-500">ç»Ÿè®¡å‘¨æœŸ</div>
                    <div class="text-2xl font-bold text-purple-600">{{ stats.period || '7 å¤©' }}</div>
                </div>
            </div>

            <!-- è¯„ä»·è¾“å…¥ -->
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <h2 class="text-lg font-semibold mb-4">ğŸ“ æ–°å»ºè¯„ä»·</h2>
                
                <div class="flex gap-4 mb-4">
                    <button @click="evalType='article'" :class="evalType==='article'?'bg-blue-600 text-white':'bg-gray-100'"
                            class="px-4 py-2 rounded">
                        ğŸ“„ æ–‡ç« è¯„ä»·
                    </button>
                    <button @click="evalType='topic'" :class="evalType==='topic'?'bg-blue-600 text-white':'bg-gray-100'"
                            class="px-4 py-2 rounded">
                        ğŸ¯ é€‰é¢˜è¯„ä»·
                    </button>
                </div>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡é¢˜</label>
                        <input v-model="inputTitle" type="text" class="w-full border rounded px-3 py-2" 
                               :placeholder="evalType==='article'?'æ–‡ç« æ ‡é¢˜':'é€‰é¢˜æ ‡é¢˜'">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            {{ evalType==='article'?'æ–‡ç« å†…å®¹':'é€‰é¢˜æè¿°' }}
                        </label>
                        <textarea v-model="inputContent" rows="6" class="w-full border rounded px-3 py-2"
                                  :placeholder="evalType==='article'?'ç²˜è´´æ–‡ç« å†…å®¹...':'æè¿°é€‰é¢˜...'"></textarea>
                    </div>
                    <button @click="evaluate" :disabled="evaluating"
                            class="w-full px-6 py-3 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400">
                        {{ evaluating ? 'è¯„ä»·ä¸­...' : 'âœ¨ å¼€å§‹è¯„ä»·' }}
                    </button>
                </div>
            </div>

            <!-- è¯„ä»·ç»“æœ -->
            <div v-if="currentResult" class="bg-white rounded-lg shadow p-6 mb-6">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-900 mb-2">{{ currentResult.title }}</h2>
                        <p class="text-sm text-gray-500">è¯„ä»·æ—¶é—´ï¼š{{ currentResult.evaluated_at }}</p>
                    </div>
                    <div class="text-right">
                        <div class="text-4xl font-bold" :class="getScoreColor(currentResult.total_score)">
                            {{ currentResult.total_score }}
                        </div>
                        <div class="text-lg font-semibold" :class="getScoreColor(currentResult.total_score)">
                            {{ currentResult.grade }}çº§ - {{ currentResult.recommendation }}
                        </div>
                    </div>
                </div>

                <!-- 5 ç»´é›·è¾¾å›¾ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“Š 5 ç»´è¯„åˆ†</h3>
                        <canvas ref="radarChart"></canvas>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“ˆ è¯¦ç»†è¯„åˆ†</h3>
                        <div class="space-y-3">
                            <div v-for="(score, dim) in currentResult.scores" :key="dim" class="flex items-center gap-2">
                                <span class="text-xs w-20">{{ getDimensionName(dim) }}</span>
                                <div class="flex-1 bg-gray-200 rounded-full h-3">
                                    <div class="bg-blue-500 h-3 rounded-full" :style="{width: score + '%'}"></div>
                                </div>
                                <span class="text-xs w-10 text-right font-semibold">{{ score }}</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ä¼˜ç‚¹å’Œå»ºè®® -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">âœ… ä¼˜ç‚¹</h3>
                        <ul class="space-y-2">
                            <li v-for="(s, i) in currentResult.strengths" :key="i" 
                                class="flex items-start gap-2 text-sm text-gray-700">
                                <span class="text-green-500 mt-1">âœ“</span>
                                <span>{{ s }}</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ’¡ æ”¹è¿›å»ºè®®</h3>
                        <ul class="space-y-2">
                            <li v-for="(s, i) in currentResult.improvements" :key="i" 
                                class="flex items-start gap-2 text-sm text-gray-700">
                                <span class="text-orange-500 mt-1">!</span>
                                <span>{{ s }}</span>
                            </li>
                        </ul>
                    </div>
                </div>

                <div v-if="currentResult.comment" class="mt-6 p-4 bg-gray-50 rounded">
                    <h3 class="text-sm font-semibold text-gray-700 mb-2">ğŸ“ æ€»ä½“è¯„ä»·</h3>
                    <p class="text-gray-700">{{ currentResult.comment }}</p>
                </div>
            </div>

            <!-- è¯„ä»·å†å² -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-4 py-3 border-b border-gray-200">
                    <h2 class="text-lg font-semibold">è¯„ä»·å†å²</h2>
                    <p class="text-sm text-gray-500">æœ€è¿‘ {{ history.length }} æ¡è¯„ä»·</p>
                </div>

                <div class="divide-y divide-gray-200">
                    <div v-for="(item, i) in history" :key="i" 
                         class="p-4 hover:bg-gray-50 cursor-pointer"
                         @click="showHistoryDetail(item)">
                        <div class="flex justify-between items-center">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="text-xs px-2 py-0.5 rounded" 
                                          :class="item.target_type==='article'?'bg-blue-100':'bg-purple-100'">
                                        {{ item.target_type==='article'?'ğŸ“„ æ–‡ç« ':'ğŸ¯ é€‰é¢˜' }}
                                    </span>
                                    <span class="text-xs text-gray-500">{{ formatTime(item.created_at) }}</span>
                                </div>
                                <h3 class="font-semibold">{{ item.comment?.substring(0, 80) || 'è¯„ä»·è®°å½•' }}...</h3>
                            </div>
                            <div class="text-right">
                                <div class="text-xl font-bold" :class="getScoreColor(item.total_score)">
                                    {{ item.total_score }}
                                </div>
                                <div class="text-sm font-semibold">{{ item.grade }}çº§</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    API_BASE: 'http://43.134.234.4:8000/api/v3',
                    evalType: 'article',
                    evalModel: 'free',
                    inputTitle: '',
                    inputContent: '',
                    evaluating: false,
                    currentResult: null,
                    stats: {},
                    history: [],
                    chart: null
                }
            },
            mounted() {
                this.loadStats();
                this.loadHistory();
            },
            methods: {
                async evaluate() {
                    if (!this.inputTitle || !this.inputContent) {
                        alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                        return;
                    }

                    this.evaluating = true;
                    try {
                        const res = await fetch(`${this.API_BASE}/evaluation/evaluate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                title: this.inputTitle,
                                content: this.inputContent,
                                type: this.evalType,
                                model: this.evalModel
                            })
                        });
                        const data = await res.json();
                        this.currentResult = data.data;
                        this.currentResult.title = this.inputTitle;
                        
                        // æ›´æ–°ç»Ÿè®¡
                        this.loadStats();
                        
                        // ç»˜åˆ¶é›·è¾¾å›¾
                        this.$nextTick(() => {
                            this.renderRadarChart();
                        });
                    } catch (e) {
                        console.error('è¯„ä»·å¤±è´¥:', e);
                        // Mock ç»“æœ
                        this.currentResult = this.getMockResult();
                    } finally {
                        this.evaluating = false;
                    }
                },
                async loadStats() {
                    try {
                        const res = await fetch(`${this.API_BASE}/evaluation/statistics`);
                        const data = await res.json();
                        this.stats = data.data || {};
                    } catch (e) {
                        console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', e);
                        this.stats = { total: 0, avg_score: 0, grades: {} };
                    }
                },
                async loadHistory() {
                    try {
                        const res = await fetch(`${this.API_BASE}/evaluation/history?limit=20`);
                        const data = await res.json();
                        this.history = data.data || [];
                    } catch (e) {
                        console.error('åŠ è½½å†å²å¤±è´¥:', e);
                        this.history = [];
                    }
                },
                renderRadarChart() {
                    const ctx = this.$refs.radarChart;
                    if (!ctx) return;

                    if (this.chart) {
                        this.chart.destroy();
                    }

                    const scores = this.currentResult.scores || {};
                    const dimensions = Object.keys(scores);
                    const values = Object.values(scores);

                    this.chart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: dimensions.map(d => this.getDimensionName(d)),
                            datasets: [{
                                label: 'è¯„åˆ†',
                                data: values,
                                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                                borderColor: 'rgb(59, 130, 246)',
                                pointBackgroundColor: 'rgb(59, 130, 246)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgb(59, 130, 246)'
                            }]
                        },
                        options: {
                            scales: {
                                r: {
                                    angleLines: { display: true },
                                    suggestedMin: 0,
                                    suggestedMax: 100
                                }
                            },
                            plugins: {
                                legend: { display: false }
                            }
                        }
                    });
                },
                showHistoryDetail(item) {
                    this.currentResult = {
                        ...item,
                        scores: {
                            content: item.content_score,
                            structure: item.structure_score,
                            expression: item.expression_score,
                            viral: item.viral_score,
                            innovation: item.innovation_score
                        },
                        strengths: item.strengths || [],
                        improvements: item.improvements || []
                    };
                    this.$nextTick(() => this.renderRadarChart());
                },
                getDimensionName(dim) {
                    const names = {
                        content: 'å†…å®¹',
                        structure: 'ç»“æ„',
                        expression: 'è¡¨è¾¾',
                        viral: 'ä¼ æ’­',
                        innovation: 'åˆ›æ–°',
                        heat: 'çƒ­åº¦',
                        potential: 'æ½œåŠ›',
                        match: 'åŒ¹é…',
                        novelty: 'æ–°é¢–',
                        feasibility: 'å¯è¡Œ'
                    };
                    return names[dim] || dim;
                },
                getScoreColor(score) {
                    if (score >= 90) return 'text-yellow-600';
                    if (score >= 80) return 'text-blue-600';
                    if (score >= 70) return 'text-green-600';
                    if (score >= 60) return 'text-orange-600';
                    return 'text-red-600';
                },
                formatTime(timeStr) {
                    if (!timeStr) return '-';
                    const date = new Date(timeStr);
                    return date.toLocaleString('zh-CN', { month: '2-digit', day: '2-digit', hour: '2-digit', minute: '2-digit' });
                },
                getMockResult() {
                    return {
                        title: this.inputTitle,
                        scores: {
                            content: Math.floor(Math.random() * 30) + 70,
                            structure: Math.floor(Math.random() * 30) + 70,
                            expression: Math.floor(Math.random() * 30) + 70,
                            viral: Math.floor(Math.random() * 30) + 70,
                            innovation: Math.floor(Math.random() * 30) + 70
                        },
                        total_score: Math.floor(Math.random() * 30) + 70,
                        grade: ['S', 'A', 'B', 'C'][Math.floor(Math.random() * 4)],
                        strengths: ['ä¼˜ç‚¹ 1', 'ä¼˜ç‚¹ 2', 'ä¼˜ç‚¹ 3'],
                        improvements: ['å»ºè®® 1', 'å»ºè®® 2', 'å»ºè®® 3'],
                        recommendation: 'æ­£å¸¸å‘å¸ƒ',
                        comment: 'æ€»ä½“è¯„ä»·ç¤ºä¾‹',
                        evaluated_at: new Date().toISOString()
                    };
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
